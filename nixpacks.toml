[phases.setup]
nixPkgs = ["nodejs_20", "python312", "chromium", "chromedriver", "zlib", "gcc", "gnumake"]

[phases.install]
cmds = [
  "npm ci",
  "python3 -m venv /opt/venv",
  "/opt/venv/bin/pip install --upgrade pip",
  "export LD_LIBRARY_PATH=$(find /nix/store -name 'libz.so.1' -exec dirname {} \\; | head -1):$LD_LIBRARY_PATH",
  "/opt/venv/bin/pip install --no-cache-dir -r requirements.txt",
]

[phases.build]
cmds = ["npm run build"]

[start]
cmd = "export LD_LIBRARY_PATH=$(find /nix/store -name 'libz.so.1' -exec dirname {} \\; | head -1):$LD_LIBRARY_PATH && npm run start"

[variables]
NODE_ENV = "production"
PYTHON_PATH = "/opt/venv/bin/python3"

